// ==========================================
// PRISMA SCHEMA - MD HEALTH CARE CENTER
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Patient/User Model
model Patient {
  id           String        @id @default(cuid())
  name         String
  phone        String        @unique
  email        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]

  @@index([phone])
  @@map("patients")
}

// Admin Model (Clinic Staff)
model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("admin") // admin, receptionist
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("admins")
}

// Service Category Model
model ServiceCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  icon        String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  services    Service[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("service_categories")
}

// Service Model
model Service {
  id           String          @id @default(cuid())
  name         String
  description  String?         @db.Text
  categoryId   String
  duration     Int             @default(30) // minutes
  price        Int?            // in MNT
  isActive     Boolean         @default(true)
  order        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  category     ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  doctors      DoctorService[]

  @@index([categoryId])
  @@map("services")
}

// Doctor Model
model Doctor {
  id             String          @id @default(cuid())
  name           String
  specialization String
  bio            String?         @db.Text
  imageUrl       String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  schedules      Schedule[]
  appointments   Appointment[]
  services       DoctorService[]

  @@index([specialization])
  @@index([isActive])
  @@map("doctors")
}

// Doctor-Service relation (which doctor can perform which services)
model DoctorService {
  id        String   @id @default(cuid())
  doctorId  String
  serviceId String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([doctorId, serviceId])
  @@map("doctor_services")
}

// Day of Week Enum
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Schedule Model (Doctor's Working Hours)
model Schedule {
  id           String    @id @default(cuid())
  doctorId     String
  dayOfWeek    DayOfWeek
  startTime    String    // "09:00"
  endTime      String    // "17:00"
  slotDuration Int       @default(30) // minutes
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
  @@index([doctorId])
  @@map("schedules")
}

// Appointment Status Enum
enum AppointmentStatus {
  PENDING     // Захиалга үүссэн, төлбөр хүлээж байна
  PAID        // Төлбөр орсон, баталгаажуулалт хүлээж байна
  CONFIRMED   // Админ баталгаажуулсан
  COMPLETED   // Үйлчилгээ авсан
  NO_SHOW     // Ирээгүй, 25000₮ буцаахгүй
  CANCELLED   // Цуцлагдсан
}

// Payment Status Enum
enum PaymentStatus {
  PENDING     // QR үүссэн, төлбөр хүлээж байна
  COMPLETED   // Төлбөр амжилттай
  FAILED      // Төлбөр амжилтгүй
  REFUNDED    // Буцаан олгосон
  EXPIRED     // Хугацаа дууссан
}

// Payment Method Enum
enum PaymentMethod {
  QPAY
  SOCIALPAY
  BANK_TRANSFER
  CASH
  ADMIN_OVERRIDE
}

// Appointment Model
model Appointment {
  id        String            @id @default(cuid())
  patientId String
  doctorId  String
  serviceId String?
  date      DateTime          @db.Date
  time      String            // "10:00"
  status    AppointmentStatus @default(PENDING)
  notes     String?           @db.Text
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor   Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service  Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  payments Payment[]

  // Prevent double booking: one doctor can't have two appointments at same time
  @@unique([doctorId, date, time])
  @@index([patientId])
  @@index([doctorId])
  @@index([serviceId])
  @@index([date])
  @@index([status])
  @@map("appointments")
}

// Payment Model
model Payment {
  id            String        @id @default(cuid())
  appointmentId String
  amount        Int           // Amount in MNT (25000 for booking fee)
  type          String        @default("BOOKING_FEE") // BOOKING_FEE | SERVICE_BALANCE
  status        PaymentStatus @default(PENDING)
  method        PaymentMethod @default(QPAY)
  
  // QR Payment fields
  qrCode        String?       @db.Text // QR code data/image
  qrUrl         String?       // Deep link URL
  invoiceId     String?       @unique // External invoice ID from payment provider
  transactionId String?       // Transaction ID from payment provider
  
  paidAt        DateTime?     // When payment was confirmed
  expiresAt     DateTime?     // QR code expiration
  
  // Refund fields
  refundedAt    DateTime?
  refundReason  String?
  
  metadata      Json?         // Additional data from payment provider
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

// OTP Model for Phone Verification
model OTP {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@map("otps")
}

// System Configuration
model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique
  value String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_configs")
}
